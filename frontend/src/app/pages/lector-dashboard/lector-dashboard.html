<div class="lector-dashboard">

  <div class="header">
    <h1>üìö Mi Panel de Pr√©stamos</h1>
    <p class="subtitulo">
      Revisa tus pr√©stamos activos, fechas de vencimiento y tu historial.
    </p>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <button 
      class="tab-btn" 
      [class.activo]="tabActivo === 'prestamos'"
      (click)="cambiarTab('prestamos')">
      Pr√©stamos activos
    </button>

    <button 
      class="tab-btn" 
      [class.activo]="tabActivo === 'historial'"
      (click)="cambiarTab('historial')">
      Historial
    </button>
  </div>

  <!-- Mensajes de estado -->
  <div *ngIf="loading" class="estado-info">
    Cargando informaci√≥n...
  </div>

  <div *ngIf="errorMessage" class="estado-error">
    {{ errorMessage }}
  </div>

  <!-- TAB: PR√âSTAMOS ACTIVOS -->
  <div *ngIf="tabActivo === 'prestamos'">

    <div *ngIf="!loading && prestamos.length === 0" class="estado-info">
      No tienes pr√©stamos activos por ahora.
    </div>

    <div class="prestamos-grid" *ngIf="prestamos.length > 0">
      <div class="prestamo-card" *ngFor="let p of prestamos">

        <div class="card-header">
          <h2 class="titulo-libro">
            {{ p.libro_titulo || ('Libro ' + p.libro_id) }}
          </h2>

          <span 
            class="chip-estado"
            [ngClass]="{
              'estado-pendiente': p.estado === 'pendiente',
              'estado-listo': p.estado === 'listo',
              'estado-prestado': p.estado === 'prestado',
              'estado-devuelto': p.estado === 'devuelto',
              'estado-rechazado': p.estado === 'rechazado',
              'estado-vencido': esVencido(p)
            }">
            <!-- Texto del estado -->
            <ng-container *ngIf="!esVencido(p)">
              {{ p.estado | titlecase }}
            </ng-container>
            <ng-container *ngIf="esVencido(p)">
              Vencido
            </ng-container>
          </span>
        </div>

        <div class="card-body">
          <p><strong>Fecha de pr√©stamo:</strong> {{ p.fecha_prestamo | date:'yyyy-MM-dd' }}</p>
          <p>
            <strong>Fecha de vencimiento:</strong>
            <span *ngIf="p.fecha_devolucion_esperada; else sinFecha">
              {{ p.fecha_devolucion_esperada | date:'yyyy-MM-dd' }}
            </span>
            <ng-template #sinFecha>
              No definida
            </ng-template>
          </p>

          <p *ngIf="esVencido(p)" class="alerta-vencido">
            ‚ö† Este pr√©stamo est√° vencido, ac√©rcate a la biblioteca.
          </p>
        </div>

        <div class="card-actions">
          <button 
            class="btn-primario"
            (click)="renovarPrestamo(p)"
            [disabled]="!puedeRenovar(p)">
            Renovar
          </button>

          <button 
            class="btn-secundario"
            (click)="devolverLibro(p)">
            Marcar como devuelto
          </button>
        </div>

      </div>
    </div>

  </div>

  <!-- TAB: HISTORIAL -->
  <div *ngIf="tabActivo === 'historial'">

    <div *ngIf="historial.length === 0" class="estado-info">
      A√∫n no tienes historial de pr√©stamos.
    </div>

    <table *ngIf="historial.length > 0" class="tabla-historial">
      <thead>
        <tr>
          <th>Libro</th>
          <th>Fecha pr√©stamo</th>
          <th>Fecha devoluci√≥n / resoluci√≥n</th>
          <th>Estado final</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let p of historial">
          <td>{{ p.libro_titulo || ('Libro ' + p.libro_id) }}</td>
          <td>{{ p.fecha_prestamo | date:'yyyy-MM-dd' }}</td>
          <td>
            <span *ngIf="p.fecha_devolucion_esperada; else sinFechaHist">
              {{ p.fecha_devolucion_esperada | date:'yyyy-MM-dd' }}
            </span>
            <ng-template #sinFechaHist>
              -
            </ng-template>
          </td>
          <td>
            <span class="chip-historial"
                  [ngClass]="{
                    'hist-devuelto': p.estado === 'devuelto',
                    'hist-rechazado': p.estado === 'rechazado'
                  }">
              {{ p.estado | titlecase }}
            </span>
          </td>
        </tr>
      </tbody>
    </table>

  </div>

  <!-- CTA inferior -->
  <div class="footer-cta">
    <a routerLink="/dashboard" class="btn-ir-catalogo">
      üîé Ir al cat√°logo de libros
    </a>
  </div>

</div>
